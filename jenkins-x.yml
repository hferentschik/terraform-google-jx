buildPack: none
pipelineConfig:
  pipelines:
    pullRequest:
      pipeline:
        agent:
          image: gcr.io/jenkinsxio/builder-terraform
        stages:
        - name: ci
          environment:
          - name: GOOGLE_APPLICATION_CREDENTIALS
            value: /secret/sa/ci_bot.json
          options:
            volumes:
            - name: sa
              secret:
                secretName: terraform-secret
                items:
                - key: terraform_google_jx_sa
                  path: sa/ci_bot.json
            containerOptions:
              volumeMounts:
              - mountPath: /secret
                name: sa
          steps:
          - name: terraform-version
            command: terraform
            args:
            - -version
          - name: terraform-init
            command: terraform
            args:
            - init
          - name: terraform-fmt
            command: terraform
            args:
            - fmt
            - -check
            - -diff
          - name: terraform-validate
            command: terraform
            args:
            - validate
          - name: run-ci-checks
            command: ./scripts/ci.sh
    release:
      pipeline:
        agent:
          image: gcr.io/jenkinsxio/builder-go
        stages:
        - name: release
          environment:
          - name: GIT_COMMITTER_EMAIL
            value: jenkins-x@googlegroups.com
          - name: GIT_COMMITTER_NAME
            value: jenkins-x-bot
          - name: GIT_AUTHOR_EMAIL
            value: jenkins-x@googlegroups.com
          - name: GIT_AUTHOR_NAME
            value: jenkins-x-bot
          steps:
          # Create the release notes
          - name: changelog
            command: ./scripts/changelog.sh
